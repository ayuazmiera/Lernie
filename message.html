<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LERNIE - Messages</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Poppins',sans-serif; background:linear-gradient(to right,#c2f0e7,#a3ccff); margin:0; padding:0; }
    nav { background:white; padding:15px 30px; display:flex; justify-content:space-evenly; font-weight:bold; font-size:18px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    nav a { text-decoration:none; color:black; }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 120px;
      box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
      z-index: 2;
      right: 0;
      margin-top: 5px;
      border-radius: 5px;
    }
    .dropdown-content a {
      color: black;
      padding: 8px 12px;
      text-decoration: none;
      display: block;
      font-size: 0.9em;
      text-align: left;
    }
    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }
    .dropdown:hover .dropdown-content {
      display: block;
    }
    .container { max-width:900px; margin:30px auto; background:white; padding:30px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    h2 { text-align:center; margin-bottom:20px; }
    .chat-list { display:flex; flex-direction:column; gap:12px; }
    .chat-item { padding:15px; border:1px solid #ddd; border-radius:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:all 0.3s ease; }
    .chat-item:hover { background:#f2f8ff; transform:translateY(-2px); }
    .chat-info { display:flex; flex-direction:column; }
    .chat-info span.name { font-weight:600; font-size:1.1em; color:#333; }
    .chat-info span.message { color:#555; font-size:0.9em; margin-top:3px; }
    .chat-time { font-size:0.8em; color:#777; }
    .back-btn { display:inline-block; margin-bottom:10px; color:#1a73e8; cursor:pointer; }
    /* Chat view */
    .chat-box { height:300px; overflow-y:auto; border:1px solid #ccc; border-radius:8px; padding:10px; margin-bottom:10px; display:flex; flex-direction:column; }
    .message { padding:8px 12px; border-radius:20px; margin:5px 0; max-width:70%; word-wrap:break-word; }
    .sent { background:#1a73e8; color:white; align-self:flex-end; margin-left:auto; }
    .received { background:#ccc; color:#333; align-self:flex-start; margin-right:auto; }
    .chat-input { display:flex; gap:10px; margin-top:10px; }
    .chat-input input[type=text] { flex-grow:1; padding:10px; border-radius:20px; border:1px solid #ccc; }
    .chat-input button { background:linear-gradient(to right,#6abcb5,#6a95cb); color:white; border:none; padding:10px 25px; border-radius:25px; cursor:pointer; font-size:16px; font-weight:600; }
    /* Reminder and file upload */
    .reminder-box { margin-top:15px; padding:10px; border:1px solid #ccc; border-radius:8px; background:#f9f9f9; }
    .reminder-box input { margin-bottom:10px; }
  </style>
</head>
<body>
<nav>
    <a href="homepage.html">Home</a>
    <a href="peerMatch.html">Peer matching</a>
    <a href="message.html">Message</a>
    <a href="studyGroup.html">Study group</a>
    <div class="dropdown">
        <a href="profile.html">Profile &#9660;</a>
        <div class="dropdown-content">
            <a href="website.html" onclick="logout()">Log out</a>
        </div>
    </div>
</nav>

<div class="container">
  <h2>Your Conversations</h2>
  <div id="chatList" class="chat-list"></div>

  <!-- Chat View -->
  <div id="chatView" style="display:none;">
    <span class="back-btn" id="backBtn">&larr; Back to chats</span>
    <h3 id="chatPeerName"></h3>
    <div class="chat-box" id="chatBox"></div>
    <div class="chat-input">
      <input type="text" id="chatMessage" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>

    <!-- Reminder Box -->
    <div class="reminder-box">
      <h4>Set Reminder</h4>
      <input type="date" id="reminderDate" placeholder="Set Date">
      <input type="time" id="reminderTime" placeholder="Set Time">
      <button id="setReminderBtn">Set Reminder</button>
      <div id="reminderList"></div>
    </div>

    <!-- File Upload -->
    <div class="file-upload">
      <h4>Upload a File</h4>
      <input type="file" id="fileInput">
      <button id="sendFileBtn">Send File</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
  import { getFirestore, collection, doc, addDoc, onSnapshot, query, orderBy, getDocs, serverTimestamp, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAsZIqVtjiLb9jmCfIMFXkpOPH2NP8uTJg",
    authDomain: "lernie-11007.firebaseapp.com",
    projectId: "lernie-11007",
    storageBucket: "lernie-11007.appspot.com",
    messagingSenderId: "270699557554",
    appId: "1:270699557554:web:e0f0037c467694689a8fab"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUserId = null;
  let currentChatId = null;
  let currentUserName = "";

  const chatListDiv = document.getElementById("chatList");
  const chatView = document.getElementById("chatView");
  const chatBox = document.getElementById("chatBox");
  const chatPeerName = document.getElementById("chatPeerName");

  // --- Wait for auth ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUserId = user.uid;
      getUserInfo();
      loadChatList();
    } else {
      alert("Please login first!");
      window.location.href = "login.html";
    }
  });

  // --- Get Current User's Info (Name) ---
  function getUserInfo() {
    const userRef = doc(db, "users", currentUserId);
    getDoc(userRef).then((docSnap) => {
      if (docSnap.exists()) {
        currentUserName = docSnap.data().name;
      }
    });
  }

  // --- Load Chat List ---
  function loadChatList() {
    const chatRef = collection(db, "messageList", currentUserId, "chats");
    onSnapshot(chatRef, (snapshot) => {
      chatListDiv.innerHTML = "";
      if (snapshot.empty) {
        chatListDiv.innerHTML = "<p>No chats yet.</p>";
        return;
      }
      snapshot.docs.forEach(docSnap => {
        const c = docSnap.data();
        const div = document.createElement("div");
        div.className = "chat-item";
        div.innerHTML = `
          <div class="chat-info">
            <span class="name">${c.peerName}</span>
            <span class="message">${c.lastMessage || ''}</span>
          </div>
          <span class="chat-time">${c.updatedAt ? new Date(c.updatedAt.toDate()).toLocaleString() : ''}</span>
        `;
        div.onclick = () => openChat(c.chatId, c.peerName);
        chatListDiv.appendChild(div);
      });
    });
  }

  // --- Open a Chat ---
  function openChat(chatId, name) {
    currentChatId = chatId;
    chatPeerName.textContent = name;
    chatListDiv.style.display = "none";
    chatView.style.display = "block";

    const messagesRef = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp"));
    onSnapshot(messagesRef, (snapshot) => {
      chatBox.innerHTML = "";
      snapshot.forEach(docSnap => {
        const m = docSnap.data();
        const div = document.createElement("div");
        div.className = "message " + (m.sender === currentUserId ? "sent" : "received");
        div.innerHTML = `<strong>${m.senderName || (m.sender === currentUserId ? currentUserName : 'Unknown')}</strong>: ${m.content}`;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  // --- Send Message ---
  document.getElementById("sendBtn").onclick = async () => {
    const text = document.getElementById("chatMessage").value.trim();
    if (!text || !currentChatId) return;

    const senderName = currentUserName; // Use current user's name here
    await addDoc(collection(db, "chats", currentChatId, "messages"), {
      sender: currentUserId,
      senderName: senderName, // Store the sender's name
      content: text,
      type: "text",
      timestamp: serverTimestamp()
    });
    document.getElementById("chatMessage").value = "";
  };

  // --- Set Reminder ---
  document.getElementById("setReminderBtn").onclick = async () => {
    const date = document.getElementById("reminderDate").value;
    const time = document.getElementById("reminderTime").value;
    if (date && time && currentChatId) {
      const reminder = `${date} ${time}`;
      const reminderRef = doc(db, "reminders", currentChatId);
      await setDoc(reminderRef, { reminder, timestamp: serverTimestamp() });
      document.getElementById("reminderList").innerHTML = `Reminder set for: ${reminder}`;
    }
  };

  // --- Upload and Send File ---
  document.getElementById("sendFileBtn").onclick = async () => {
    const fileInput = document.getElementById("fileInput");
    if (fileInput.files.length > 0 && currentChatId) {
      const file = fileInput.files[0];
      const fileRef = collection(db, "chats", currentChatId, "messages");
      const fileData = { sender: currentUserId, content: file.name, type: "file", timestamp: serverTimestamp() };
      await addDoc(fileRef, fileData);
      alert("File sent successfully!");
    }
  };

  // --- Back button ---
  document.getElementById("backBtn").onclick = () => {
    chatView.style.display = "none";
    chatListDiv.style.display = "flex";
    currentChatId = null;
  };
</script>
</body>
</html>
